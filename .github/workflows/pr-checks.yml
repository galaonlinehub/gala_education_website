name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - develop
      - main

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm run lint || echo "Please run 'pnpm run lint' and fix any errors"

      - name: Build
        run: pnpm run build

  check-pr-target:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR target branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const baseBranch = pr.base.ref;
            const headBranch = pr.head.ref;

            console.log(`PR from: ${headBranch} → ${baseBranch}`);

            // Rule 1: Feature/bugfix branches should target develop
            if (headBranch.startsWith('feature/') ||
                headBranch.startsWith('bugfix/') ||
                headBranch.startsWith('fix/') ||
                headBranch.startsWith('refactor/') ||
                headBranch.startsWith('style/')) {
              if (baseBranch !== 'develop') {
                core.setFailed(`❌ Feature branches must target 'develop', not '${baseBranch}'`);
              } else {
                console.log('✅ Feature branch correctly targets develop');
              }
            }

            // Rule 2: Only develop can target main (plus hotfixes)
            if (baseBranch === 'main') {
              if (headBranch !== 'develop' && !headBranch.startsWith('hotfix/')) {
                core.setFailed(`❌ Only 'develop' or 'hotfix/*' branches can create PRs to 'main'. Current branch: '${headBranch}'`);
              } else {
                console.log('✅ Valid PR to main branch');
              }
            }

  label-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Auto-label PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const headBranch = pr.head.ref;
            const labels = [];

            // Auto-label based on branch name
            if (headBranch.startsWith('feature/')) labels.push('feature');
            if (headBranch.startsWith('bugfix/') || headBranch.startsWith('fix/')) labels.push('bugfix');
            if (headBranch.startsWith('hotfix/')) labels.push('hotfix');
            if (headBranch.startsWith('refactor/')) labels.push('refactor');
            if (headBranch.startsWith('style/')) labels.push('style');
            if (headBranch.startsWith('docs/')) labels.push('documentation');

            // Auto-label based on target branch
            if (pr.base.ref === 'main') labels.push('release');
            if (pr.base.ref === 'develop') labels.push('development');

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: labels
              });
              console.log(`Added labels: ${labels.join(', ')}`);
            }
